{{/* Build-time filtering for upcoming events */}}
{{ $now := now }}
{{ $candidates := where (where site.RegularPages "Type" "events") ".Params.active" "!=" false }}

{{ $upcoming := slice }}
{{ range $candidates }}
  {{ $endStr := .Params.end | default .Params.start }}
  {{ with $endStr }}
    {{ $end := time . }}
    {{ if ge $end $now }}
      {{ $upcoming = $upcoming | append .Page }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $sorted := sort $upcoming ".Params.start" }}

<ul class="events">
  {{ range $sorted }}
    <li class="event-item">
      <a href="{{ .RelPermalink }}">{{ .Title }}</a>
      {{ with .Params.start }} <time datetime="{{ . }}">{{ . }}</time>{{ end }}
      {{ with .Params.end }} – <time datetime="{{ . }}">{{ . }}</time>{{ end }}
      {{ with .Params.location }} — {{ . }}{{ end }}
    </li>
  {{ else }}
    <li>No upcoming events.</li>
  {{ end }}
</ul>